@page "/reset-password"
@layout AuthLayout
@using JobTracker.Services
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Reset Password - Job Tracker</PageTitle>

<div class="auth-form">
    <h2 style="text-align: center; margin-bottom: 24px;">Set New Password</h2>

    @if (resetComplete)
    {
        <div class="alert alert-success">
            <strong>Password reset successful!</strong><br />
            You can now sign in with your new password.
        </div>
        <div class="auth-links" style="margin-top: 20px;">
            <a href="/login" class="btn btn-primary" style="display: inline-block; text-decoration: none;">Sign In</a>
        </div>
    }
    else if (invalidToken)
    {
        <div class="alert alert-danger">
            <strong>Invalid or expired link</strong><br />
            This password reset link is invalid or has expired. Please request a new one.
        </div>
        <div class="auth-links">
            <a href="/forgot-password">Request New Reset Link</a>
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        <EditForm Model="model" OnValidSubmit="HandleSubmit" FormName="reset-password">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label for="password">New Password</label>
                <InputText id="password" @bind-Value="model.Password" type="password" class="form-control" placeholder="Enter new password" />
                <ValidationMessage For="() => model.Password" />
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <InputText id="confirmPassword" @bind-Value="model.ConfirmPassword" type="password" class="form-control" placeholder="Confirm new password" />
                <ValidationMessage For="() => model.ConfirmPassword" />
            </div>

            <button type="submit" class="btn btn-primary" disabled="@isLoading">
                @if (isLoading)
                {
                    <span>Resetting...</span>
                }
                else
                {
                    <span>Reset Password</span>
                }
            </button>
        </EditForm>

        <div class="auth-links">
            <a href="/login">Back to Sign In</a>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery]
    private string? Token { get; set; }

    [SupplyParameterFromForm]
    private ResetPasswordModel model { get; set; } = null!;

    private string? errorMessage;
    private bool isLoading;
    private bool resetComplete;
    private bool invalidToken;

    protected override void OnInitialized()
    {
        model ??= new();
        if (string.IsNullOrEmpty(Token))
        {
            invalidToken = true;
            return;
        }

        // Validate token exists and is not expired
        var user = AuthService.ValidateResetToken(Token);
        if (user == null)
        {
            invalidToken = true;
        }
    }

    private void HandleSubmit()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            if (model.Password != model.ConfirmPassword)
            {
                errorMessage = "Passwords do not match.";
                return;
            }

            if (model.Password.Length < 8)
            {
                errorMessage = "Password must be at least 8 characters.";
                return;
            }

            var success = AuthService.ResetPassword(Token!, model.Password);
            if (!success)
            {
                invalidToken = true;
                return;
            }

            resetComplete = true;
        }
        finally
        {
            isLoading = false;
        }
    }

    private class ResetPasswordModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Password is required")]
        [System.ComponentModel.DataAnnotations.MinLength(8, ErrorMessage = "Password must be at least 8 characters")]
        public string Password { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Please confirm your password")]
        [System.ComponentModel.DataAnnotations.Compare(nameof(Password), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
